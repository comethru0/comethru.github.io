<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœç”«äººç”Ÿä¸‰å¢ƒÂ·æ–‡å²é—¯å…³</title>
    <style>
        body {
            font-family: "æ¥·ä½“", cursive;
            background: #f3e9d2;
            color: #3e2723;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('https://img.zcool.cn/community/01a5ea5b8788c2a80121ad4738a5f0.jpg@1280w_1l_2o_100sh.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .stage {
            margin-bottom: 30px;
            border-bottom: 2px solid #8d6e63;
            padding-bottom: 20px;
        }
        .question {
            margin: 15px 0;
            padding: 15px;
            background: #fff8f0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .correct {
            background: #e8f5e9;
        }
        .incorrect {
            background: #ffebee;
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        button {
            background: #8d6e63;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            transition: all 0.3s;
        }
        button:hover {
            background: #6d4c41;
            transform: scale(1.05);
        }
        #score {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff3e0;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #6d4c41;
        }
        .highlight {
            position: relative;
            z-index: 10;
        }
        .highlight::after {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #ff5722;
            border-radius: 7px;
            animation: borderPulse 2s infinite;
        }
        @keyframes borderPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .retry-btn {
            background: #ff9800;
            margin-top: 10px;
        }
        .next-stage-btn {
            background: #4caf50;
            margin-top: 10px;
        }
        .complete-btn {
            background: #9c27b0;
            margin-top: 10px;
        }
        .answer-feedback {
            color: #2e7d32;
            font-weight: bold;
            margin-top: 5px;
        }
        .correct-answer {
            color: #d32f2f;
            font-weight: bold;
        }
        .review-panel {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
        }
        .review-container {
            display: none;
            margin-top: 20px;
        }
        .stage-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .stage-btn {
            margin: 0 10px;
            padding: 8px 15px;
            background: #8d6e63;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .stage-btn.active {
            background: #6d4c41;
        }
    </style>
</head>
<body>
    <div id="score">å½“å‰å¾—åˆ†ï¼š0</div>
    <div class="container" id="gameContainer"></div>
    <div class="container review-container" id="reviewContainer"></div>

<script>
// åŸºäºå¾®è¯¾ç¨¿çš„ä¸‰é˜¶æ®µé¢˜åº“ï¼ˆæ¯é˜¶æ®µ10é¢˜ï¼‰
const stages = [
    { // é’å¹´å£®å¿—ï¼ˆ10é¢˜ï¼‰
        title: "ğŸ‹ è£˜é©¬è½»ç‹‚Â·å°‘å¹´æ„æ°”",
        questions: [
            {
                type: "choice",
                question: "æœç”«24å²ç§‘ä¸¾è½ç¬¬ååˆ›ä½œçš„ä»£è¡¨ä½œæ˜¯ï¼Ÿ",
                options: ["ã€Šæœ›å²³ã€‹","ã€Šæ˜¥æœ›ã€‹","ã€Šç™»é«˜ã€‹"],
                answer: 0,
                explanation: "ã€Šæœ›å²³ã€‹æ˜¯æœç”«é’å¹´æ—¶æœŸçš„ä»£è¡¨ä½œï¼Œå±•ç°äº†è±ªè¿ˆæ°”æ¦‚"
            },
            {
                type: "judge",
                question: "ã€Šæœ›å²³ã€‹ä¸­'ä¼šå½“å‡Œç»é¡¶'ä»…è¡¨è¾¾ç™»å±±æ„¿æœ›ï¼Œæ²¡æœ‰æ”¿æ²»éšå–»ã€‚",
                answer: false,
                explanation: "æ­¤å¥æš—å«è¯—äººæ”€ç™»äº‹ä¸šé«˜å³°çš„æ”¿æ²»æŠ±è´Ÿ"
            },
            {
                type: "choice",
                question: "åæ˜ ç››å”æ°”è±¡çš„æœç”«é’å¹´è¯—ä½œæ˜¯ï¼š",
                options: ["ã€Šé¥®ä¸­å…«ä»™æ­Œã€‹","ã€Šå…µè½¦è¡Œã€‹","ã€ŠçŸ³å£•åã€‹"],
                answer: 0,
                explanation: "ã€Šé¥®ä¸­å…«ä»™æ­Œã€‹æç»˜äº†ç››å”æ–‡äººçš„è±ªæ”¾ç”Ÿæ´»"
            },
            {
                type: "choice",
                question: "æœç”«æ—©æœŸæ”¿æ²»ç†æƒ³çš„ç›´æ¥è¡¨è¾¾æ˜¯ï¼š",
                options: ["è‡´å›å°§èˆœä¸Šï¼Œå†ä½¿é£ä¿—æ·³","æœ±é—¨é…’è‚‰è‡­ï¼Œè·¯æœ‰å†»æ­»éª¨","å®‰å¾—å¹¿å¦åƒä¸‡é—´"],
                answer: 0,
                explanation: "è¿™ä¸¤å¥è¯—ç›´æ¥è¡¨è¾¾äº†æœç”«çš„æ”¿æ²»ç†æƒ³"
            },
            {
                type: "judge",
                question: "æœç”«é’å¹´æ—¶æœŸè¯—æ­Œä»¥æ²‰éƒé¡¿æŒ«é£æ ¼ä¸ºä¸»ã€‚",
                answer: false,
                explanation: "æ²‰éƒé¡¿æŒ«æ˜¯æœç”«ä¸­æ™šå¹´å½¢æˆçš„é£æ ¼"
            },
            {
                type: "choice",
                question: "æœç”«é’å¹´æ—¶æœŸæ¼«æ¸¸é½èµµæ—¶åˆ›ä½œçš„è¯—å¥æ˜¯ï¼š",
                options: ["ä¼šå½“å‡Œç»é¡¶ï¼Œä¸€è§ˆä¼—å±±å°","æ„Ÿæ—¶èŠ±æº…æ³ªï¼Œæ¨åˆ«é¸ŸæƒŠå¿ƒ","æ˜Ÿå‚å¹³é‡é˜”ï¼Œæœˆæ¶Œå¤§æ±Ÿæµ"],
                answer: 0,
                explanation: "è¿™æ˜¯ã€Šæœ›å²³ã€‹ä¸­çš„åå¥ï¼Œä½œäºæ¼«æ¸¸æ—¶æœŸ"
            },
            {
                type: "judge",
                question: "æœç”«åœ¨ã€Šå¥‰èµ éŸ¦å·¦ä¸ä¸ˆäºŒåäºŒéŸµã€‹ä¸­è¡¨è¾¾äº†æ€€æ‰ä¸é‡çš„æ„¤æ‡‘ã€‚",
                answer: true,
                explanation: "è¯—ä¸­'çº¨ç»”ä¸é¥¿æ­»ï¼Œå„’å† å¤šè¯¯èº«'ç­‰å¥å¯è§"
            },
            {
                type: "choice",
                question: "ä»¥ä¸‹å“ªé¡¹ä¸æ˜¯æœç”«é’å¹´æ—¶æœŸçš„ç‰¹å¾ï¼Ÿ",
                options: ["è£˜é©¬è½»ç‹‚","å¿§å›½å¿§æ°‘","è±ªæ”¾ä¸ç¾"],
                answer: 1,
                explanation: "å¿§å›½å¿§æ°‘æ˜¯æœç”«ä¸­æ™šå¹´è¯—æ­Œçš„ä¸»è¦ç‰¹å¾"
            },
            {
                type: "choice",
                question: "æœç”«æ—©æœŸè¯—æ­Œå—å“ªä½è¯—äººå½±å“æœ€æ·±ï¼Ÿ",
                options: ["æç™½","å±ˆåŸ","é™¶æ¸Šæ˜"],
                answer: 0,
                explanation: "æœç”«ä¸æç™½äº¤æ¸¸å¯†åˆ‡ï¼Œæ—©æœŸè¯—é£å—å…¶å½±å“"
            },
            {
                type: "judge",
                question: "æœç”«é’å¹´æ—¶æœŸå·²ç»å½¢æˆäº†ç°å®ä¸»ä¹‰çš„åˆ›ä½œé£æ ¼ã€‚",
                answer: false,
                explanation: "ç°å®ä¸»ä¹‰é£æ ¼æ˜¯åœ¨å®‰å²ä¹‹ä¹±åæˆç†Ÿçš„"
            }
        ]
    },
    { // ä¸­å¹´ç–¾å‘¼ï¼ˆ10é¢˜ï¼‰
        title: "âš”ï¸ æœ±é—¨å‰‘é¸£Â·ä¹±ä¸–æ‚²æ­Œ",
        questions: [
            {
                type: "choice",
                question: "ã€Šä¸½äººè¡Œã€‹ä¸­å¯¹æ¯”æå†™çš„ä¸¤ä¸ªç¤¾ä¼šç¾¤ä½“æ˜¯ï¼š",
                options: ["å°†å£«ä¸ç™¾å§“","æƒè´µä¸é¥¥æ°‘","åƒ§ä¾£ä¸å¹³æ°‘"],
                answer: 1,
                explanation: "é€šè¿‡æ¨æ°å…„å¦¹çš„å¥¢åæ­éœ²ç¤¾ä¼šä¸å…¬"
            },
            {
                type: "judge",
                question: "ã€Šè‡ªäº¬èµ´å¥‰å…ˆå¿å’æ€€äº”ç™¾å­—ã€‹åŒ…å«'æœ±é—¨é…’è‚‰è‡­'åå¥ã€‚",
                answer: true,
                explanation: "è¿™æ˜¯æœç”«ç°å®ä¸»ä¹‰è¯—æ­Œçš„ä»£è¡¨ä½œä¹‹ä¸€"
            },
            {
                type: "choice",
                question: "æœç”«åˆ›ä½œ'ä¸‰åä¸‰åˆ«'çš„å†å²èƒŒæ™¯æ˜¯ï¼š",
                options: ["å¼€å…ƒç››ä¸–","å®‰å²ä¹‹ä¹±","è—©é•‡å‰²æ®"],
                answer: 1,
                explanation: "è¿™ç»„è¯—æ·±åˆ»åæ˜ äº†å®‰å²ä¹‹ä¹±ç»™äººæ°‘å¸¦æ¥çš„è‹¦éš¾"
            },
            {
                type: "choice",
                question: "ã€Šæ˜¥æœ›ã€‹ä¸­'æ„Ÿæ—¶èŠ±æº…æ³ª'çš„'æ—¶'æŒ‡ï¼š",
                options: ["å­£èŠ‚å˜æ¢","å›½å®¶å±éš¾","ä¸ªäººè¡°è€"],
                answer: 1,
                explanation: "è¯—äººå› å›½å®¶æ®‹ç ´è€Œæ„Ÿä¼¤è½æ³ª"
            },
            {
                type: "judge",
                question: "æœç”«åœ¨é•¿å®‰åå¹´å§‹ç»ˆå…³æ³¨ä¸ªäººä»•é€”å¾—å¤±ã€‚",
                answer: false,
                explanation: "æ­¤æœŸåˆ›ä½œå·²å¼€å§‹å…³æ³¨ç¤¾ä¼šç°å®"
            },
            {
                type: "choice",
                question: "ã€Šå…µè½¦è¡Œã€‹åæ˜ çš„ç¤¾ä¼šé—®é¢˜æ˜¯ï¼š",
                options: ["å®¦å®˜ä¸“æƒ","è¿å¹´å¾æˆ˜","åœŸåœ°å…¼å¹¶"],
                answer: 1,
                explanation: "æ­éœ²å”ç„å®—é•¿æœŸå¼€è¾¹æˆ˜äº‰ç»™äººæ°‘å¸¦æ¥çš„ç—›è‹¦"
            },
            {
                type: "judge",
                question: "æœç”«åœ¨å®‰å²ä¹‹ä¹±ä¸­è¢«å›å†›ä¿˜è™åé€ƒè„±ã€‚",
                answer: true,
                explanation: "æœç”«æ›¾è¢«å›å†›ä¿˜è‡³é•¿å®‰ï¼Œåå†’é™©é€ƒå‡º"
            },
            {
                type: "choice",
                question: "ä»¥ä¸‹å“ªé¦–è¯—ä¸å±äºæœç”«ä¸­å¹´æ—¶æœŸçš„ä½œå“ï¼Ÿ",
                options: ["ã€Šæœˆå¤œã€‹","ã€Šç¾Œæ‘ä¸‰é¦–ã€‹","ã€Šç™»å²³é˜³æ¥¼ã€‹"],
                answer: 2,
                explanation: "ã€Šç™»å²³é˜³æ¥¼ã€‹æ˜¯æœç”«æ™šå¹´æ¼‚æ³Šæ¹–å—æ—¶çš„ä½œå“"
            },
            {
                type: "choice",
                question: "æœç”«ä¸­å¹´æ—¶æœŸè¯—æ­Œåˆ›ä½œçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ï¼š",
                options: ["æµªæ¼«ä¸»ä¹‰è‰²å½©æµ“åš","ç°å®ä¸»ä¹‰é£æ ¼æˆç†Ÿ","å½¢å¼ä¸»ä¹‰å€¾å‘æ˜æ˜¾"],
                answer: 1,
                explanation: "å®‰å²ä¹‹ä¹±ä¿ƒä½¿æœç”«ç°å®ä¸»ä¹‰åˆ›ä½œè¾¾åˆ°é«˜å³°"
            },
            {
                type: "judge",
                question: "æœç”«ä¸­å¹´æ—¶æœŸçš„è¯—æ­Œä¸»è¦æå†™ä¸ªäººç”Ÿæ´»çäº‹ã€‚",
                answer: false,
                explanation: "æ­¤æœŸè¯—æ­Œå¤šåæ˜ ç¤¾ä¼šç°å®å’Œäººæ°‘ç–¾è‹¦"
            }
        ]
    },
    { // æš®å¹´é•¿æ­Œï¼ˆ10é¢˜ï¼‰
        title: "ğŸŒ¾ è‰å ‚ç§‹é£Â·ä»è€…ä¹‹å…‰",
        questions: [
            {
                type: "choice",
                question: "ã€ŠèŒ…å±‹ä¸ºç§‹é£æ‰€ç ´æ­Œã€‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š",
                options: ["ä¸ªäººå›°è‹¦","è‡ªç„¶èµç¾","æµä¸–æƒ…æ€€"],
                answer: 2,
                explanation: "'å®‰å¾—å¹¿å¦åƒä¸‡é—´'ä½“ç°åšå¤§èƒ¸æ€€"
            },
            {
                type: "judge",
                question: "ã€Šç§‹å…´å…«é¦–ã€‹æ ‡å¿—ç€æœç”«ä¸ƒå¾‹è‰ºæœ¯çš„æˆç†Ÿã€‚",
                answer: true,
                explanation: "è¿™ç»„ä¸ƒå¾‹æ˜¯æœç”«æ™šå¹´å¾‹è¯—çš„ä»£è¡¨ä½œ"
            },
            {
                type: "choice",
                question: "æœç”«è¢«ç§°ä¸º'è¯—å²'ä¸»è¦æ˜¯å› ä¸ºï¼š",
                options: ["è®°å½•å…¸ç« åˆ¶åº¦","åæ˜ ç¤¾ä¼šå®å†µ","æå†™å®«å»·ç”Ÿæ´»"],
                answer: 1,
                explanation: "ä»–çš„è¯—çœŸå®è®°å½•äº†å”ä»£ç”±ç››è½¬è¡°çš„å†å²"
            },
            {
                type: "choice",
                question: "æœç”«æ™šå¹´æ€æƒ³å¢ƒç•Œçš„é›†ä¸­ä½“ç°æ˜¯ï¼š",
                options: ["ä¼šå½“å‡Œç»é¡¶","å¤§åº‡å¤©ä¸‹å¯’å£«","å›½ç ´å±±æ²³åœ¨"],
                answer: 1,
                explanation: "ä½“ç°äº†æ¨å·±åŠäººã€å¿§å›½å¿§æ°‘çš„æƒ…æ€€"
            },
            {
                type: "judge",
                question: "ã€Šæ±Ÿå—é€¢æé¾Ÿå¹´ã€‹æ˜¯æœç”«æ™šå¹´ç»å¥ä»£è¡¨ä½œã€‚",
                answer: true,
                explanation: "è¿™é¦–ä¸ƒç»å«è“„æ·±æ²‰ï¼Œå¯“æ…¨å¹äºå™äº‹ä¹‹ä¸­"
            },
            {
                type: "choice",
                question: "æœç”«æ™šå¹´æ¼‚æ³Šè¥¿å—æ—¶æœŸçš„åˆ›ä½œç‰¹ç‚¹æ˜¯ï¼š",
                options: ["é›„æµ‘è±ªæ”¾","æ²‰éƒé¡¿æŒ«","æ¸…æ–°è‡ªç„¶"],
                answer: 1,
                explanation: "è¯—é£æ›´åŠ æ²‰éƒé¡¿æŒ«ã€è‹åŠ²æ‚²å‡‰"
            },
            {
                type: "judge",
                question: "ã€Šç™»é«˜ã€‹è¢«èª‰ä¸º'å¤ä»Šä¸ƒå¾‹ç¬¬ä¸€'ã€‚",
                answer: true,
                explanation: "æ­¤è¯—æ ¼å¾‹ç²¾ä¸¥ï¼Œæ„å¢ƒæ·±è¿œï¼Œå ªç§°ä¸ƒå¾‹å…¸èŒƒ"
            },
            {
                type: "choice",
                question: "æœç”«æ™šå¹´çš„å“ªé¦–è¯—è¡¨è¾¾äº†å¯¹è¯¸è‘›äº®çš„æ•¬ä»°ï¼Ÿ",
                options: ["ã€Šèœ€ç›¸ã€‹","ã€Šå®¢è‡³ã€‹","ã€Šç»å¥ã€‹"],
                answer: 0,
                explanation: "'å‡ºå¸ˆæœªæ·èº«å…ˆæ­»'è¡¨è¾¾äº†å¯¹è¯¸è‘›äº®çš„æƒ‹æƒœ"
            },
            {
                type: "choice",
                question: "ä»¥ä¸‹å“ªé¡¹æœ€èƒ½ä½“ç°æœç”«æ™šå¹´è¯—æ­Œçš„è‰ºæœ¯æˆå°±ï¼Ÿ",
                options: ["è¯­è¨€é€šä¿—","æ ¼å¾‹ä¸¥è°¨","æƒ³è±¡å¥‡ç‰¹"],
                answer: 1,
                explanation: "æœç”«æ™šå¹´åœ¨å¾‹è¯—æ ¼å¾‹ä¸Šè¾¾åˆ°ç‚‰ç«çº¯é’çš„å¢ƒç•Œ"
            },
            {
                type: "judge",
                question: "æœç”«åœ¨å¤”å·æ—¶æœŸåˆ›ä½œæ•°é‡å‡å°‘ï¼Œè´¨é‡ä¸‹é™ã€‚",
                answer: false,
                explanation: "å¤”å·æ—¶æœŸæ˜¯æœç”«åˆ›ä½œçš„åˆä¸€ä¸ªé«˜å³°"
            }
        ]
    }
];

let currentStage = 0;
let totalScore = 0;
let firstErrorId = null;
let hasErrors = false;
let userAnswers = []; // è®°å½•ç”¨æˆ·ç­”æ¡ˆ
let allCorrect = false; // æ ‡è®°æ˜¯å¦å…¨éƒ¨ç­”å¯¹
let stageScores = [0, 0, 0]; // è®°å½•æ¯ä¸ªé˜¶æ®µçš„å¾—åˆ†
let gameCompleted = false; // æ ‡è®°æ¸¸æˆæ˜¯å¦å®Œæˆ

function renderStage(stageIndex) {
    const stage = stages[stageIndex];
    let html = `
        <div class="stage">
            <h2 style="color:#6d4c41; text-align:center">${stage.title}</h2>
    `;
    
    stage.questions.forEach((q, index) => {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ·ç­”æ¡ˆ
        const userAnswer = userAnswers[stageIndex] ? userAnswers[stageIndex][index] : null;
        const isCorrect = userAnswer !== null && userAnswer === q.answer;
        
        html += `
            <div class="question ${isCorrect ? 'correct' : ''}" id="q${index}">
                <p>${index+1}. ${q.question}</p>
                ${q.type === "choice" ? 
                    q.options.map((opt, i) => `
                        <label>
                            <input type="radio" name="q${index}" value="${i}" 
                                ${userAnswer === i ? 'checked' : ''}
                                ${userAnswer !== null || gameCompleted ? 'disabled' : ''}>
                            ${opt}
                        </label><br>
                    `).join('') : 
                    `
                    <label><input type="radio" name="q${index}" value="true" 
                        ${userAnswer === true ? 'checked' : ''}
                        ${userAnswer !== null || gameCompleted ? 'disabled' : ''}> æ­£ç¡®</label>
                    <label><input type="radio" name="q${index}" value="false" 
                        ${userAnswer === false ? 'checked' : ''}
                        ${userAnswer !== null || gameCompleted ? 'disabled' : ''}> é”™è¯¯</label>
                    `
                }
                ${userAnswer !== null || gameCompleted ? 
                    `<div class="answer-feedback">${isCorrect ? 'âœ“ å›ç­”æ­£ç¡®' : 'âœ— å›ç­”é”™è¯¯'}: <span class="${isCorrect ? '' : 'correct-answer'}">${
                        q.type === "choice" ? q.options[q.answer] : q.answer ? "æ­£ç¡®" : "é”™è¯¯"
                    }</span><br>${q.explanation}</div>` : ''}
            </div>
        `;
    });

    if (gameCompleted) {
        html += `
            <button onclick="showReview()">æŸ¥çœ‹å…¨éƒ¨é¢˜ç›®</button>
            <button class="complete-btn" onclick="completeChallenge()">å®ŒæˆæŒ‘æˆ˜</button>
        `;
    } else if (hasErrors) {
        html += `
            <button class="retry-btn" onclick="resetStage(${stageIndex})">é‡æ–°ä½œç­”é”™è¯¯é¢˜ç›®</button>
            ${stageIndex < 2 ? 
                `<button onclick="nextStage(${stageIndex})">è¿›å…¥ä¸‹ä¸€å…³</button>` : 
                `<button class="complete-btn" onclick="completeAllStages()">å®Œæˆå…¨éƒ¨é¢˜ç›®</button>`}
        `;
    } else if (allCorrect) {
        html += `
            <div class="review-panel">
                <p>ğŸ‰ æ­å–œæ‚¨å…¨éƒ¨ç­”å¯¹ï¼è¯·æŸ¥çœ‹é¢˜ç›®è§£æåç»§ç»­</p>
                ${stageIndex < 2 ? 
                    `<button class="next-stage-btn" onclick="nextStage(${stageIndex})">è¿›å…¥ä¸‹ä¸€å…³</button>` : 
                    `<button class="complete-btn" onclick="completeAllStages()">å®Œæˆå…¨éƒ¨é¢˜ç›®</button>`}
            </div>
        `;
    } else {
        html += `<button onclick="checkAnswers(${stageIndex})">æäº¤æœ¬å…³ç­”æ¡ˆ</button>`;
    }
    
    document.getElementById("gameContainer").innerHTML = html;
}

function resetStage(stageIndex) {
    // åªé‡ç½®é”™è¯¯é¢˜ç›®çš„ç­”æ¡ˆ
    const stage = stages[stageIndex];
    stage.questions.forEach((q, index) => {
        if (userAnswers[stageIndex] && userAnswers[stageIndex][index] !== q.answer) {
            userAnswers[stageIndex][index] = null;
        }
    });
    hasErrors = false;
    allCorrect = false;
    renderStage(stageIndex);
}

function completeAllStages() {
    gameCompleted = true;
    renderStage(currentStage);
}

function completeChallenge() {
    const finalComment = totalScore >= 135 ? "å­¦å¯Œäº”è½¦ï¼" : 
                       totalScore >= 120 ? "åšå­¦å¤šæ‰ï¼" :
                       totalScore >= 90 ? "ç•¥æœ‰å°æˆï¼" : "å†æ¥å†å‰ï¼";
    
    // åˆ›å»ºæ€è€ƒé¢˜HTML
    const reflectionHtml = `
        <div class="container" style="margin-top: 20px;">
            <h2 style="color:#6d4c41; text-align:center">ğŸŒŸ è¯¾åæ€è€ƒä¸å»¶ä¼¸</h2>
            
            <div class="question" style="background:#e1f5fe;">
                <h3>æ€è€ƒé¢˜ä¸€ï¼šå¤ä»Šå¯¹è¯</h3>
                <p>é²è¿…è¯´ï¼š"æœç”«ä¼¼ä¹ä¸æ˜¯å¤äººï¼Œå°±å¥½åƒä»Šå¤©è¿˜æ´»åœ¨æˆ‘ä»¬å †é‡Œä¼¼çš„ã€‚"è¯·ç»“åˆå¾®è¯¾ä¸­æåˆ°çš„ç°ä»£éé—ä¼ æ‰¿äº‹ä¾‹ï¼ˆå¦‚å·©ä¹‰å‰ªçº¸ã€æœç”«æ–‡åŒ–å™¨å‹å¤åˆ»ç­‰ï¼‰ï¼Œæ€è€ƒï¼š</p>
                <ol>
                    <li>å½“ä»£ç¤¾ä¼šæœ‰å“ªäº›ä¸æœç”«"å®‰å¾—å¹¿å¦åƒä¸‡é—´"ç²¾ç¥ä¸€è„‰ç›¸æ‰¿çš„ç°è±¡ï¼Ÿ</li>
                    <li>å¦‚æœä½ è¦è®¾è®¡ä¸€ä¸ªç°ä»£è‰ºæœ¯é¡¹ç›®ä¼ æ‰¿æœç”«ç²¾ç¥ï¼Œä¼šé‡‡ç”¨ä»€ä¹ˆå½¢å¼ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>
                </ol>
                <p><strong>å»ºè®®ï¼š</strong></p>
                <ul>
                    <li>å¯é‡‡è®¿èº«è¾¹é•¿è¾ˆæˆ–æŸ¥é˜…æ–°é—»ï¼Œåˆ—ä¸¾1-2ä¸ªå…·ä½“æ¡ˆä¾‹</li>
                    <li>å‚è€ƒå½“ä»£è‰ºæœ¯å½¢å¼å¦‚æ•°å­—åª’ä½“è‰ºæœ¯ã€æ²‰æµ¸å¼æˆå‰§ç­‰åˆ›æ–°è¡¨è¾¾æ–¹å¼</li>
                </ul>
            </div>
            
            <div class="question" style="background:#f1f8e9;">
                <h3>æ€è€ƒé¢˜äºŒï¼šè¯—åœ£çš„ç°ä»£å›å“</h3>
                <p>BBCæ¨å‡ºçš„çºªå½•ç‰‡ã€Šæœç”«ï¼šä¸­å›½æœ€ä¼Ÿå¤§çš„è¯—äººã€‹å‘è¥¿æ–¹ä»‹ç»äº†æœç”«è¯—æ­Œï¼Œå¼•å‘çƒ­è®®ã€‚æœç”«è¯—ä½œå±•ç°äº†å†å²æ¸©æƒ…ã€åšçˆ±ä¸åŠ›é‡ï¼Œåœ¨2023å¹´ç–«æƒ…æœŸé—´å°¤å…¶å‡¸æ˜¾äººç±»å‘½è¿å…±åŒä½“ç†å¿µã€‚è¯·ç»“åˆæœ¬çºªå½•ç‰‡åŠç›¸å…³è®¨è®ºï¼Œå›´ç»•"æœç”«ç²¾ç¥çš„ç°å®æ„ä¹‰åŠå…¶å¯¹å½“ä»£é’å¹´çš„å½±å“"è¿™ä¸€ä¸»é¢˜ï¼Œå†™ä¸€ç¯‡çŸ­æ–‡ï¼ˆå­—æ•°ä¸é™ï¼‰ï¼Œä½“ç°ä½ çš„æ€è€ƒä¸è§è§£ã€‚</p>
                <p><strong>å»ºè®®ï¼š</strong></p>
                <ul>
                    <li>è§‚çœ‹BBCçºªå½•ç‰‡ã€Šæœç”«ï¼šä¸­å›½æœ€ä¼Ÿå¤§çš„è¯—äººã€‹åŠç›¸å…³è¯„è®º</li>
                    <li>ç»“åˆç–«æƒ…ä¸­çš„æ„Ÿäººäº‹è¿¹ï¼Œæ€è€ƒæœç”«"ä»çˆ±"ç²¾ç¥çš„ç°ä»£è¡¨è¾¾</li>
                    <li>å¯ä»å›½é™…è§†è§’åˆ†ææœç”«è¯—æ­Œä¸­çš„äººç±»å…±åŒä»·å€¼</li>
                    <li>æ€è€ƒä½œä¸ºå½“ä»£é’å¹´å¦‚ä½•ä¼ æ‰¿æœç”«çš„ç¤¾ä¼šè´£ä»»æ„Ÿ</li>
                </ul>
                <p style="font-style:italic; color:#666;">æ³¨ï¼šæœ¬é¢˜ä¸ºå¼€æ”¾æ€§æ€è€ƒé¢˜ï¼Œä¸è®¾æ ‡å‡†ç­”æ¡ˆï¼Œè¯·å°½æƒ…è¡¨è¾¾ä½ çš„è§è§£ã€‚</p>
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <p>ğŸ‰ é—¯å…³å®Œæˆï¼æœ€ç»ˆå¾—åˆ†ï¼š${totalScore}/150</p>
                <p style="font-size:1.2em; color:#d81b60;">${finalComment}</p>
                <p>æœç”«ç²¾ç¥æ°¸å­˜ï¼æœŸå¾…ä½ åœ¨è¯¾åæ€è€ƒé¢˜ä¸­çš„ç²¾å½©è¡¨ç°ã€‚</p>
                <button onclick="location.reload()" style="background:#26a69a;">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
            </div>
        </div>
    `;
    
    // æ›¿æ¢æ¸¸æˆå®¹å™¨å†…å®¹
    document.getElementById("gameContainer").innerHTML = reflectionHtml;
    document.getElementById("reviewContainer").style.display = "none";
    document.getElementById("score").style.display = "none";
}

function nextStage(stageIndex) {
    if (stageIndex < 2) {
        currentStage++;
        hasErrors = false;
        allCorrect = false;
        renderStage(currentStage);
    }
}

function checkAnswers(stageIndex) {
    if (!userAnswers[stageIndex]) {
        userAnswers[stageIndex] = [];
    }

    let correctCount = 0;
    const stage = stages[stageIndex];
    firstErrorId = null;
    hasErrors = false;
    allCorrect = false;
    
    stage.questions.forEach((q, index) => {
        const questionDiv = document.getElementById(`q${index}`);
        let userAnswer;
        
        if(q.type === "choice") {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            userAnswer = selected ? parseInt(selected.value) : null;
        } else {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            userAnswer = selected ? (selected.value === "true") : null;
        }

        // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
        userAnswers[stageIndex][index] = userAnswer;

        if(userAnswer === q.answer) {
            correctCount++;
        } else {
            hasErrors = true;
            // è®°å½•ç¬¬ä¸€æ¡é”™è¯¯çš„é¢˜ç›®ID
            if (firstErrorId === null) {
                firstErrorId = `q${index}`;
            }
        }
    });

    // æ›´æ–°å½“å‰é˜¶æ®µå¾—åˆ†
    stageScores[stageIndex] = correctCount * 5;
    
    // é‡æ–°è®¡ç®—æ€»åˆ†
    totalScore = stageScores.reduce((sum, score) => sum + score, 0);
    
    document.getElementById("score").textContent = `å½“å‰å¾—åˆ†ï¼š${totalScore}`;
    
    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ç­”å¯¹
    allCorrect = !hasErrors;
    
    // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåé¦ˆ
    renderStage(stageIndex);
    
    // å¦‚æœæœ‰é”™è¯¯ï¼Œæ»šåŠ¨åˆ°ç¬¬ä¸€æ¡é”™è¯¯é¢˜ç›®
    if (firstErrorId !== null) {
        setTimeout(() => {
            const errorElement = document.getElementById(firstErrorId);
            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            errorElement.classList.add("highlight");
            
            alert(`æœ¬å…³å¾—åˆ†ï¼š${stageScores[stageIndex]}/50\nè¯·æŸ¥çœ‹æ ‡è®°çš„é”™è¯¯é¢˜ç›®ï¼`);
        }, 100);
    } else {
        alert(`ğŸ‰ æ­å–œæ‚¨å…¨éƒ¨ç­”å¯¹ï¼å¾—åˆ†ä¸º${stageScores[stageIndex]}/50\nè¯·æŸ¥çœ‹é¢˜ç›®è§£æåç»§ç»­`);
    }
}

function showReview() {
    document.getElementById("gameContainer").style.display = "none";
    document.getElementById("reviewContainer").style.display = "block";
    
    let html = `
        <h2 style="color:#6d4c41; text-align:center">ğŸ“š å…¨éƒ¨é¢˜ç›®å›é¡¾</h2>
        <div class="stage-selector">
            ${stages.map((stage, index) => `
                <button class="stage-btn ${index === 0 ? 'active' : ''}" onclick="showReviewStage(${index})">
                    ${stage.title}
                </button>
            `).join('')}
        </div>
        <div id="reviewStageContent"></div>
        <button onclick="backToGame()">è¿”å›ç­”é¢˜ç•Œé¢</button>
    `;
    
    document.getElementById("reviewContainer").innerHTML = html;
    showReviewStage(0);
}

function showReviewStage(stageIndex) {
    const stage = stages[stageIndex];
    let html = `
        <h3 style="text-align:center; color:#5d4037">${stage.title}</h3>
    `;
    
    stage.questions.forEach((q, index) => {
        const userAnswer = userAnswers[stageIndex] ? userAnswers[stageIndex][index] : null;
        const isCorrect = userAnswer !== null && userAnswer === q.answer;
        
        html += `
            <div class="question ${isCorrect ? 'correct' : 'incorrect'}">
                <p>${index+1}. ${q.question}</p>
                <p>ä½ çš„ç­”æ¡ˆ: <strong>${userAnswer !== null ? 
                    (q.type === "choice" ? q.options[userAnswer] : userAnswer ? "æ­£ç¡®" : "é”™è¯¯") : 
                    "æœªä½œç­”"}</strong></p>
                <p>æ­£ç¡®ç­”æ¡ˆ: <strong class="correct-answer">${
                    q.type === "choice" ? q.options[q.answer] : q.answer ? "æ­£ç¡®" : "é”™è¯¯"
                }</strong></p>
                <div class="answer-feedback">è§£æ: ${q.explanation}</div>
            </div>
        `;
    });
    
    document.getElementById("reviewStageContent").innerHTML = html;
    
    // æ›´æ–°æ´»åŠ¨æ ‡ç­¾æ ·å¼
    document.querySelectorAll('.stage-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.stage-btn')[stageIndex].classList.add('active');
}

function backToGame() {
    document.getElementById("gameContainer").style.display = "block";
    document.getElementById("reviewContainer").style.display = "none";
    renderStage(currentStage);
}

// åˆå§‹åŒ–æ¸¸æˆ
renderStage(0);
</script>
</body>
</html>